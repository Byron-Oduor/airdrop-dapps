<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoJib (CJIB) Token dApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: #6366f1;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header Section -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fas fa-coins text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold">CryptoJib (CJIB)</h1>
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <div id="networkStatus" class="hidden bg-white/20 px-3 py-1 rounded-full text-sm flex items-center">
                        <span id="networkName" class="mr-1"></span>
                        <i id="networkIcon" class="fas fa-circle text-xs"></i>
                    </div>
                    <div id="walletBalance" class="hidden bg-white/20 px-3 py-1 rounded-full text-sm">
                        Balance: <span id="balanceAmount">0</span> CJIB
                    </div>
                    <button id="connectWalletBtn" class="bg-white text-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition">
                        Connect Wallet
                    </button>
                    <div id="walletAddress" class="hidden bg-white/20 px-3 py-1 rounded-full text-sm font-mono">
                        <span id="shortAddress"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Mint Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-indigo-100 p-2 rounded-full mr-3">
                            <i class="fas fa-coins text-indigo-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Mint CJIB Tokens</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Mint new CJIB tokens to your wallet address</p>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="mintAmount">
                            Amount to Mint
                        </label>
                        <input id="mintAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="number" placeholder="1000">
                    </div>
                    <button id="mintBtn" class="w-full btn-primary text-white py-2 px-4 rounded-md font-medium">
                        Mint Tokens
                    </button>
                </div>
            </div>

            <!-- Airdrop Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-purple-100 p-2 rounded-full mr-3">
                            <i class="fas fa-parachute-box text-purple-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Airdrop CJIB</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Send CJIB tokens to multiple addresses at once</p>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="airdropAddresses">
                            Recipient Addresses (comma separated)
                        </label>
                        <textarea id="airdropAddresses" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="0x123...,0x456..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="airdropAmount">
                            Amount per Address
                        </label>
                        <input id="airdropAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" type="number" placeholder="100">
                    </div>
                    <button id="airdropBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md font-medium">
                        Execute Airdrop
                    </button>
                </div>
            </div>

            <!-- Stake Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-teal-100 p-2 rounded-full mr-3">
                            <i class="fas fa-lock text-teal-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Stake CJIB</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Lock your CJIB tokens to earn rewards</p>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="stakeAmount">
                            Amount to Stake
                        </label>
                        <input id="stakeAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" type="number" placeholder="1000">
                    </div>
                    <button id="stakeBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-md font-medium">
                        Stake Tokens
                    </button>
                </div>
            </div>

            <!-- Unstake Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-amber-100 p-2 rounded-full mr-3">
                            <i class="fas fa-unlock text-amber-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Unstake CJIB</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Unlock your staked CJIB tokens</p>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="unstakeAmount">
                            Amount to Unstake
                        </label>
                        <input id="unstakeAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" type="number" placeholder="1000">
                    </div>
                    <button id="unstakeBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 px-4 rounded-md font-medium">
                        Unstake Tokens
                    </button>
                </div>
            </div>

            <!-- History Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-2 rounded-full mr-3">
                            <i class="fas fa-history text-blue-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Transaction History</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Recent transactions for your address</p>
                    <div class="mb-4 max-h-60 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable" class="bg-white divide-y divide-gray-200">
                                <!-- History items will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="exportHistoryBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium">
                        Export to CSV
                    </button>
                </div>
            </div>

            <!-- Referral Card -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-green-100 p-2 rounded-full mr-3">
                            <i class="fas fa-user-friends text-green-600"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Referral Program</h2>
                    </div>
                    <p class="text-gray-600 mb-4">Earn rewards by referring friends</p>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">
                            Your Referral Link
                        </label>
                        <div class="flex">
                            <input id="referralLink" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none" type="text" readonly>
                            <button id="copyReferralBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-r-md">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">
                            Your Referrer
                        </label>
                        <input id="referrerAddress" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none" type="text" readonly>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="modalTitle">Transaction in Progress</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex items-center justify-center py-4" id="modalSpinner">
                    <i class="fas fa-spinner fa-spin text-indigo-600 text-4xl"></i>
                </div>
                <p class="text-center text-gray-700" id="modalMessage">Please wait while we process your transaction...</p>
            </div>
            <div class="hidden" id="modalSuccess">
                <div class="flex items-center justify-center text-green-500 py-4">
                    <i class="fas fa-check-circle text-4xl"></i>
                </div>
                <p class="text-center text-gray-700">Transaction completed successfully!</p>
                <a href="#" target="_blank" class="block text-center text-indigo-600 mt-2 text-sm" id="txHashLink">View on explorer</a>
            </div>
            <div class="hidden" id="modalError">
                <div class="flex items-center justify-center text-red-500 py-4">
                    <i class="fas fa-exclamation-circle text-4xl"></i>
                </div>
                <p class="text-center text-gray-700" id="errorMessage">Transaction failed. Please try again.</p>
            </div>
        </div>
    </div>

    <script>
        // Contract details
        const contractAddress = '0xC42c4d7d3E560AF2E02281870cC8D0685f891457';
        const contractABI = [
            // ERC20 standard functions
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{"name": "", "type": "string"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "_owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "balance", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "_to", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "transfer",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            // Custom CJIB functions
            {
                "constant": false,
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "mint",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "recipients", "type": "address[]"},
                    {"name": "amount", "type": "uint256"}
                ],
                "name": "airdrop",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "stake",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [{"name": "amount", "type": "uint256"}],
                "name": "unstake",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "user", "type": "address"}],
                "name": "getReferrer",
                "outputs": [{"name": "", "type": "address"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            // Events
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "from", "type": "address"},
                    {"indexed": true, "name": "to", "type": "address"},
                    {"indexed": false, "name": "value", "type": "uint256"}
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "user", "type": "address"},
                    {"indexed": false, "name": "amount", "type": "uint256"}
                ],
                "name": "Staked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "name": "user", "type": "address"},
                    {"indexed": false, "name": "amount", "type": "uint256"}
                ],
                "name": "Unstaked",
                "type": "event"
            }
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let currentAccount;
        let currentNetwork;
        let transactionHistory = [];

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletAddress = document.getElementById('walletAddress');
        const shortAddress = document.getElementById('shortAddress');
        const walletBalance = document.getElementById('walletBalance');
        const balanceAmount = document.getElementById('balanceAmount');
        const networkStatus = document.getElementById('networkStatus');
        const networkName = document.getElementById('networkName');
        const networkIcon = document.getElementById('networkIcon');

        // Transaction buttons
        const mintBtn = document.getElementById('mintBtn');
        const airdropBtn = document.getElementById('airdropBtn');
        const stakeBtn = document.getElementById('stakeBtn');
        const unstakeBtn = document.getElementById('unstakeBtn');

        // Input fields
        const mintAmount = document.getElementById('mintAmount');
        const airdropAmount = document.getElementById('airdropAmount');
        const airdropAddresses = document.getElementById('airdropAddresses');
        const stakeAmount = document.getElementById('stakeAmount');
        const unstakeAmount = document.getElementById('unstakeAmount');

        // History section
        const historyTable = document.getElementById('historyTable');
        const exportHistoryBtn = document.getElementById('exportHistoryBtn');

        // Referral section
        const referralLink = document.getElementById('referralLink');
        const copyReferralBtn = document.getElementById('copyReferralBtn');
        const referrerAddress = document.getElementById('referrerAddress');

        // Modal elements
        const transactionModal = document.getElementById('transactionModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalSpinner = document.getElementById('modalSpinner');
        const modalSuccess = document.getElementById('modalSuccess');
        const modalError = document.getElementById('modalError');
        const errorMessage = document.getElementById('errorMessage');
        const txHashLink = document.getElementById('txHashLink');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', async () => {
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        currentAccount = accounts[0];
                        updateUI();
                    } else {
                        // User disconnected all accounts
                        resetUI();
                    }
                });
                
                // Listen for chain changes
                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
                
                // Try to connect automatically if previously connected
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    await updateUI();
                }
            } else {
                // MetaMask not installed
                connectWalletBtn.textContent = 'Install MetaMask';
                connectWalletBtn.onclick = () => {
                    window.open('https://metamask.io/', '_blank');
                };
            }
            
            // Set up event listeners
            setupEventListeners();
        });

        // Set up all event listeners
        function setupEventListeners() {
            // Connect wallet button
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // Transaction buttons
            mintBtn.addEventListener('click', mintTokens);
            airdropBtn.addEventListener('click', executeAirdrop);
            stakeBtn.addEventListener('click', stakeTokens);
            unstakeBtn.addEventListener('click', unstakeTokens);
            
            // History button
            exportHistoryBtn.addEventListener('click', exportHistoryToCSV);
            
            // Referral button
            copyReferralBtn.addEventListener('click', copyReferralLink);
            
            // Modal button
            closeModalBtn.addEventListener('click', () => {
                transactionModal.classList.add('hidden');
            });
        }

        // Connect wallet function
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use this dApp!');
                return;
            }
            
            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                
                // Get network ID
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                currentNetwork = parseInt(chainId, 16);
                
                // Update UI
                await updateUI();
                
                // Show success message
                showModal('Wallet Connected', 'Your wallet has been successfully connected!');
                setTimeout(() => {
                    transactionModal.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showErrorModal('Connection Error', error.message);
            }
        }

        // Update UI with wallet and network info
        async function updateUI() {
            if (!currentAccount) return;
            
            // Update wallet address display
            walletAddress.classList.remove('hidden');
            shortAddress.textContent = `${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
            
            // Update wallet balance
            await updateBalance();
            
            // Update network status
            updateNetworkStatus();
            
            // Update connect button text
            connectWalletBtn.textContent = 'Connected';
            connectWalletBtn.classList.add('bg-green-100', 'text-green-800');
            connectWalletBtn.classList.remove('bg-white', 'text-indigo-600');
            
            // Initialize contract
            signer = provider.getSigner();
            contract = new ethers.Contract(contractAddress, contractABI, signer);
            
            // Load transaction history
            await loadTransactionHistory();
            
            // Update referral info
            updateReferralInfo();
        }

        // Reset UI when wallet is disconnected
        function resetUI() {
            currentAccount = null;
            walletAddress.classList.add('hidden');
            walletBalance.classList.add('hidden');
            networkStatus.classList.add('hidden');
            
            connectWalletBtn.textContent = 'Connect Wallet';
            connectWalletBtn.classList.remove('bg-green-100', 'text-green-800');
            connectWalletBtn.classList.add('bg-white', 'text-indigo-600');
            
            // Clear history table
            historyTable.innerHTML = '';
            transactionHistory = [];
            
            // Clear referral info
            referralLink.value = '';
            referrerAddress.value = '';
        }

        // Update wallet balance
        async function updateBalance() {
            if (!currentAccount) return;
            
            try {
                const balance = await contract.balanceOf(currentAccount);
                const formattedBalance = ethers.utils.formatUnits(balance, 18);
                
                walletBalance.classList.remove('hidden');
                balanceAmount.textContent = parseFloat(formattedBalance).toFixed(2);
            } catch (error) {
                console.error('Error fetching balance:', error);
            }
        }

        // Update network status display
        function updateNetworkStatus() {
            if (!currentNetwork) return;
            
            networkStatus.classList.remove('hidden');
            
            // BNB Testnet (chainId 97)
            if (currentNetwork === 97) {
                networkName.textContent = 'BNB Testnet';
                networkIcon.className = 'fas fa-circle text-xs text-green-500';
            } else {
                networkName.textContent = 'Wrong Network';
                networkIcon.className = 'fas fa-circle text-xs text-red-500';
                showErrorModal('Wrong Network', 'Please connect to BNB Testnet (ChainID: 97)');
            }
        }

        // Update referral information
        async function updateReferralInfo() {
            if (!currentAccount || !contract) return;
            
            try {
                // Generate referral link
                const baseUrl = window.location.href.split('?')[0];
                const refLink = `${baseUrl}?ref=${currentAccount}`;
                referralLink.value = refLink;
                
                // Check if user has a referrer
                const referrer = await contract.getReferrer(currentAccount);
                if (referrer !== ethers.constants.AddressZero) {
                    referrerAddress.value = `${referrer.substring(0, 6)}...${referrer.substring(38)}`;
                } else {
                    referrerAddress.value = 'No referrer';
                }
            } catch (error) {
                console.error('Error fetching referral info:', error);
            }
        }

        // Mint tokens function
        async function mintTokens() {
            if (!validateInput(mintAmount, 'Please enter a valid amount to mint')) return;
            if (!await checkNetwork()) return;
            
            const amount = ethers.utils.parseUnits(mintAmount.value, 18);
            
            try {
                showModal('Minting Tokens', 'Please confirm the transaction in your wallet...');
                
                const tx = await contract.mint(amount);
                showModal('Minting Tokens', 'Transaction sent. Waiting for confirmation...');
                
                const receipt = await tx.wait();
                showSuccessModal('Tokens Minted', `Successfully minted ${mintAmount.value} CJIB tokens!`, tx.hash);
                
                // Update balance and history
                await updateBalance();
                await loadTransactionHistory();
                
                // Clear input
                mintAmount.value = '';
            } catch (error) {
                console.error('Error minting tokens:', error);
                showErrorModal('Mint Failed', error.message);
            }
        }

        // Execute airdrop function
        async function executeAirdrop() {
            if (!validateInput(airdropAmount, 'Please enter a valid amount to airdrop')) return;
            if (!validateInput(airdropAddresses, 'Please enter at least one recipient address')) return;
            if (!await checkNetwork()) return;
            
            // Parse addresses
            const addresses = airdropAddresses.value.split(',')
                .map(addr => addr.trim())
                .filter(addr => ethers.utils.isAddress(addr));
            
            if (addresses.length === 0) {
                showErrorModal('Invalid Addresses', 'Please enter at least one valid recipient address');
                return;
            }
            
            const amount = ethers.utils.parseUnits(airdropAmount.value, 18);
            
            try {
                showModal('Executing Airdrop', 'Please confirm the transaction in your wallet...');
                
                const tx = await contract.airdrop(addresses, amount);
                showModal('Executing Airdrop', 'Transaction sent. Waiting for confirmation...');
                
                const receipt = await tx.wait();
                showSuccessModal('Airdrop Complete', `Successfully airdropped ${airdropAmount.value} CJIB tokens to ${addresses.length} addresses!`, tx.hash);
                
                // Update balance and history
                await updateBalance();
                await loadTransactionHistory();
                
                // Clear inputs
                airdropAmount.value = '';
                airdropAddresses.value = '';
            } catch (error) {
                console.error('Error executing airdrop:', error);
                showErrorModal('Airdrop Failed', error.message);
            }
        }

        // Stake tokens function
        async function stakeTokens() {
            if (!validateInput(stakeAmount, 'Please enter a valid amount to stake')) return;
            if (!await checkNetwork()) return;
            
            const amount = ethers.utils.parseUnits(stakeAmount.value, 18);
            
            try {
                showModal('Staking Tokens', 'Please confirm the transaction in your wallet...');
                
                const tx = await contract.stake(amount);
                showModal('Staking Tokens', 'Transaction sent. Waiting for confirmation...');
                
                const receipt = await tx.wait();
                showSuccessModal('Tokens Staked', `Successfully staked ${stakeAmount.value} CJIB tokens!`, tx.hash);
                
                // Update balance and history
                await updateBalance();
                await loadTransactionHistory();
                
                // Clear input
                stakeAmount.value = '';
            } catch (error) {
                console.error('Error staking tokens:', error);
                showErrorModal('Stake Failed', error.message);
            }
        }

        // Unstake tokens function
        async function unstakeTokens() {
            if (!validateInput(unstakeAmount, 'Please enter a valid amount to unstake')) return;
            if (!await checkNetwork()) return;
            
            const amount = ethers.utils.parseUnits(unstakeAmount.value, 18);
            
            try {
                showModal('Unstaking Tokens', 'Please confirm the transaction in your wallet...');
                
                const tx = await contract.unstake(amount);
                showModal('Unstaking Tokens', 'Transaction sent. Waiting for confirmation...');
                
                const receipt = await tx.wait();
                showSuccessModal('Tokens Unstaked', `Successfully unstaked ${unstakeAmount.value} CJIB tokens!`, tx.hash);
                
                // Update balance and history
                await updateBalance();
                await loadTransactionHistory();
                
                // Clear input
                unstakeAmount.value = '';
            } catch (error) {
                console.error('Error unstaking tokens:', error);
                showErrorModal('Unstake Failed', error.message);
            }
        }

        // Load transaction history
        async function loadTransactionHistory() {
            if (!currentAccount || !contract) return;
            
            try {
                // Get transfer events
                const transferFilter = contract.filters.Transfer(null, currentAccount);
                const transferEvents = await contract.queryFilter(transferFilter);
                
                // Get stake events
                const stakeFilter = contract.filters.Staked(currentAccount);
                const stakeEvents = await contract.queryFilter(stakeFilter);
                
                // Get unstake events
                const unstakeFilter = contract.filters.Unstaked(currentAccount);
                const unstakeEvents = await contract.queryFilter(unstakeFilter);
                
                // Combine and sort events by block number
                const allEvents = [...transferEvents, ...stakeEvents, ...unstakeEvents]
                    .sort((a, b) => b.blockNumber - a.blockNumber)
                    .slice(0, 10); // Show only last 10 events
                
                // Clear previous history
                historyTable.innerHTML = '';
                transactionHistory = [];
                
                // Process events and add to table
                allEvents.forEach(event => {
                    let type, amount;
                    
                    if (event.event === 'Transfer') {
                        type = 'Transfer';
                        amount = ethers.utils.formatUnits(event.args.value, 18);
                    } else if (event.event === 'Staked') {
                        type = 'Stake';
                        amount = ethers.utils.formatUnits(event.args.amount, 18);
                    } else if (event.event === 'Unstaked') {
                        type = 'Unstake';
                        amount = ethers.utils.formatUnits(event.args.amount, 18);
                    }
                    
                    // Add to transaction history array for export
                    transactionHistory.push({
                        type,
                        amount,
                        txHash: event.transactionHash,
                        timestamp: new Date().toISOString() // Note: Would need block timestamp for real implementation
                    });
                    
                    // Add to table
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-2 py-1 whitespace-nowrap text-sm font-medium text-gray-900">${type}</td>
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">${amount} CJIB</td>
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-500">Just now</td>
                    `;
                    historyTable.appendChild(row);
                });
                
                if (allEvents.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" class="px-2 py-4 text-center text-sm text-gray-500">No transactions found</td>
                    `;
                    historyTable.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading transaction history:', error);
            }
        }

        // Export history to CSV
        function exportHistoryToCSV() {
            if (transactionHistory.length === 0) {
                alert('No transaction history to export');
                return;
            }
            
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Type,Amount (CJIB),Transaction Hash,Timestamp\n";
            
            transactionHistory.forEach(tx => {
                csvContent += `${tx.type},${tx.amount},${tx.txHash},${tx.timestamp}\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "cjib_transaction_history.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        }

        // Copy referral link to clipboard
        function copyReferralLink() {
            if (!referralLink.value) return;
            
            referralLink.select();
            referralLink.setSelectionRange(0, 99999);
            document.execCommand('copy');
            
            // Show tooltip or notification
            const originalText = copyReferralBtn.innerHTML;
            copyReferralBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                copyReferralBtn.innerHTML = originalText;
            }, 2000);
        }

        // Validate input field
        function validateInput(inputElement, errorMessage) {
            if (!inputElement.value || isNaN(inputElement.value) {
                showErrorModal('Invalid Input', errorMessage);
                inputElement.focus();
                return false;
            }
            return true;
        }

        // Check if connected to correct network
        async function checkNetwork() {
            if (currentNetwork !== 97) {
                showErrorModal('Wrong Network', 'Please connect to BNB Testnet (ChainID: 97)');
                return false;
            }
            return true;
        }

        // Show modal with spinner
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalSpinner.classList.remove('hidden');
            modalSuccess.classList.add('hidden');
            modalError.classList.add('hidden');
            transactionModal.classList.remove('hidden');
        }

        // Show success modal
        function showSuccessModal(title, message, txHash) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalSpinner.classList.add('hidden');
            modalSuccess.classList.remove('hidden');
            modalError.classList.add('hidden');
            
            if (txHash) {
                txHashLink.href = `https://testnet.bscscan.com/tx/${txHash}`;
                txHashLink.classList.remove('hidden');
            } else {
                txHashLink.classList.add('hidden');
            }
        }

        // Show error modal
        function showErrorModal(title, message) {
            modalTitle.textContent = title;
            errorMessage.textContent = message;
            modalSpinner.classList.add('hidden');
            modalSuccess.classList.add('hidden');
            modalError.classList.remove('hidden');
            transactionModal.classList.remove('hidden');
        }
    </script>
</body>
</html>
